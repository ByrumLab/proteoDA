---
title: " "
output: 
  html_document:
    mathjax: null
    self_contained: true
editor_options: 
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE, echo = F, include = F}
#knitr::opts_knit$set(base.dir = "~/Projects/proteomicsDIA/")
knitr::opts_chunk$set(warning = F, message = F, fig.align = "center", echo = F)
options(width = 10000)
# Load packages -----------------------------------------------------------
library(knitr)
library(devtools)
library(htmlwidgets)
load_all()
```

```{css, echo=FALSE}
.main-container {
  max-width: 1000px;
  margin-left: auto;
  margin-right: auto;
}
```

```{r logo, fig.align="left", out.width="40%"}
knitr::include_graphics(path = "~/Projects/proteomicsDIA/for_testing/logo_higherres.png", rel_path = F)
```


```{r, cache = T}
# Get all the stuff that would be input in our function

ext_reb <- extract_data(file = "for_testing/Example Data/rebello/Samples Report of Rebello_040522.csv",
                       pipe = "DIA",
                       enrich = "protein")
target_reb <- make_targets(file = "for_testing/Example Data/rebello/Rebello_040522_metafile_DIA.csv",
                           sampleIDs = colnames(ext_reb$data),
                           pipe = "DIA",
                           enrich = "protein")

sub_reb <- subset_targets(targets = target_reb,
                          filter_list = list(group = "Pool"))
norm_reb <- process_data(data = ext_reb$data,
                         targets = sub_reb$targets,
                         min.reps = 2,
                         min.grps = 1)
des_reb <- make_design(targets = norm_reb$targets,
                           group_column = "group",
                           factor_columns = NULL,
                           paired_column = NULL)
contrasts_rebello <- make_contrasts(file = "for_testing/Example Data/rebello/contrasts.csv",
                                    design = des_reb$design)
fit_reb <- fit_limma_model(data = norm_reb$normList[["vsn"]],
                           design_obj = des_reb,
                           contrasts_obj = contrasts_rebello)
results_reb <- extract_limma_DE_results(limma_fit = fit_reb)

annotation <- ext_reb$annot[rownames(results_reb$data),]
contrast <- names(results_reb$stats_by_contrast)[1]
```

### `r stringr::str_replace(contrast, "_vs_", " vs ")` 

# {.tabset .tabset-fade .tabset-pills}

```{r, results = "asis"}
data <- results_reb$stats_by_contrast[[contrast]]
data$`P value` <- data$P.Value
data$`Adjusted P value` <- data$adj.P.Val
data$negLog10rawP <- -log(data$P.Value, 10)
data$negLog10adjP <- -log(data$adj.P.Val, 10)
data$sig.PVal <- ifelse(is.na(data$sig.PVal), 0, data$sig.PVal) 
data$sig.FDR <- ifelse(is.na(data$sig.FDR), 0, data$sig.FDR)  
groups <- norm_reb$targets$group
height <- 1000
width <- 1000

plot_list <- c("Volcano raw P",
               "Volcano adjusted P",
               "MD raw P",
               "MD adjusted P")

src <- lapply(plot_list, function(plot) {
  plot <- deparse(plot)
  knitr::knit_expand(file = "for_testing/glimma_xy_plot.Rmd")
})

res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
cat(res, sep = "\n")

```

# {-}

Some issues: 

* Fixed the issues of the x-axis limits for the MD plots and expression plots. 

* The saved plots created by the Save Plot button above look bad/weird: I think because they're transparent? Might just be the way they display on my Linux machine. 

* In the table, the stats columns it outputs are based on the x and y axes. Would be nice to have it output the raw and adjusted p-values on the regular scale, not the -log10 scale. We may want to have it output additional columns as well. Still need to fix this. 




